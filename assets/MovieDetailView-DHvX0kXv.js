import{_ as R,u as T,r as A,c as y,i as E,b as l,o as a,g as s,d as i,t as _,e as c,F as q,j,k as w,w as u,h as f,E as g,l as O,m as W,n as G,p as H,q as J,s as K,v as F,f as Q}from"./index-7FuSJdjK.js";import{u as X}from"./comment-CbQgWbvR.js";const Y={class:"comment-section"},Z={key:0,class:"comments-list"},ee={class:"comment-header"},te={class:"user-info"},oe={class:"username"},se={class:"comment-date"},ne={class:"comment-content"},re={key:0,class:"comment-actions"},ae={key:1,class:"no-comments"},ie={key:2,class:"add-comment"},le={key:3,class:"login-prompt"},ce={__name:"CommentSection",props:{movieId:{type:String,required:!0}},setup(P){const M=P,v=T(),p=X(),d=A(""),n=A(!1),N=A({}),U=y(()=>v.isAuthenticated),I=async r=>{const k=(await O.getUserInfo(r)).data;N.value[r]=k.avatarUrl?`https://mondaydb.top${k.avatarUrl}`:""},h=r=>r?new Date(r).toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"",C=r=>U.value?v.currentUser.id===r.userId:!1,x=async()=>{if(!d.value.trim()){g.warning("评论内容不能为空");return}n.value=!0;try{await p.addComment(v.currentUser.id,M.movieId,d.value.trim()),d.value="",await S(),g.success("评论成功")}catch(r){console.error("提交评论失败:",r),g.error("评论发布失败")}finally{n.value=!1}},L=async r=>{W.confirm("确认删除此评论?","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await p.deleteComment(r.userId,r.id),await S(),g.success("评论已删除")}catch(t){console.error("删除评论失败:",t),g.error("删除评论失败")}}).catch(()=>{})},D=y(()=>p.movieComments),S=async()=>{try{await p.fetchMovieComments(M.movieId);const r=[...new Set(p.movieComments.map(t=>t.userId))];for(const t of r)await I(t)}catch(r){console.error("获取评论失败:",r)}};return E(()=>{S()}),(r,t)=>{const k=c("el-divider"),e=c("el-avatar"),o=c("el-button"),$=c("el-input"),b=c("el-form-item"),z=c("el-form"),V=c("router-link");return a(),l("div",Y,[D.value.length>0?(a(),l("div",Z,[s("h3",null,"评论 ("+_(D.value.length)+")",1),i(k),(a(!0),l(q,null,j(D.value,m=>(a(),l("div",{key:m.createdAt,class:"comment-item"},[s("div",ee,[s("div",te,[i(e,{size:"small",src:N.value[m.userId]||""},null,8,["src"]),s("span",oe,_(m.userName),1)]),s("div",se,_(h(m.createdAt)),1)]),s("div",ne,_(m.comment),1),C(m)?(a(),l("div",re,[i(o,{size:"small",type:"danger",onClick:B=>L(m)},{default:u(()=>t[1]||(t[1]=[f("删除")])),_:2,__:[1]},1032,["onClick"])])):w("",!0)]))),128))])):(a(),l("div",ae,t[2]||(t[2]=[s("p",null,"暂无评论",-1)]))),U.value?(a(),l("div",ie,[t[4]||(t[4]=s("h3",null,"添加评论",-1)),i(k),i(z,null,{default:u(()=>[i(b,null,{default:u(()=>[i($,{modelValue:d.value,"onUpdate:modelValue":t[0]||(t[0]=m=>d.value=m),type:"textarea",rows:3,placeholder:"写下你的评论..."},null,8,["modelValue"])]),_:1}),i(b,null,{default:u(()=>[i(o,{type:"primary",loading:n.value,onClick:x},{default:u(()=>t[3]||(t[3]=[f("提交评论")])),_:1,__:[3]},8,["loading"])]),_:1})]),_:1})])):(a(),l("div",le,[i(V,{to:"/login"},{default:u(()=>t[5]||(t[5]=[f("登录")])),_:1,__:[5]}),t[6]||(t[6]=f(" 后才能发表评论 "))]))])}}},ue=R(ce,[["__scopeId","data-v-b114df30"]]),de={class:"movie-detail"},me={key:0,class:"loading"},ve={key:1,class:"error"},_e={key:2,class:"movie-content"},pe={class:"content"},fe={class:"back-button"},ge={class:"header"},ye={class:"poster-container"},he=["src"],ke={key:1,class:"no-poster poster"},be={class:"info"},we={class:"title"},Ie={class:"meta"},Ce={key:0,class:"release-date"},De={key:1,class:"rating"},Se={key:2,class:"budget"},$e={key:3,class:"box-office"},Me={class:"actions"},Ne={class:"overview"},Ue={__name:"MovieDetailView",setup(P){const M=H();Q();const v=G(),p=T(),d=y(()=>M.params.id),n=y(()=>v.currentMovie),N=y(()=>v.loading),U=y(()=>v.error),I=y(()=>p.isAuthenticated),h=A(!1),C=async()=>{try{await v.getMovieDetails(d.value),I.value&&x()}catch(e){console.error("获取电影详情失败:",e)}},x=async()=>{try{const e=p.currentUser.id,o=await v.getUserMovieList(e);h.value=o.some($=>$.movieId.toString()===d.value.toString())}catch(e){console.error("获取影单失败:",e)}},L=async()=>{try{const e=p.currentUser.id;await v.addToMovieList(e,d.value),h.value=!0,g.success("已添加到影单")}catch(e){g.error("添加失败"),console.error("添加到影单失败:",e)}},D=async()=>{try{const e=p.currentUser.id;await v.removeFromMovieList(e,d.value),h.value=!1,g.success("已从影单移除")}catch(e){g.error("移除失败"),console.error("从影单移除失败:",e)}},S=e=>e?new Date(e).toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"}):"",r=e=>{if(!e||e==="N/A")return"N/A";const o=parseInt(e,10);return isNaN(o)?"N/A":new Intl.NumberFormat("zh-CN",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(o)},t=e=>e?e.startsWith("http")?e:`https://image.tmdb.org/t/p/w500${e}`:"/placeholder.jpg",k=y(()=>{if(!n.value.backdropPath)return{backgroundImage:"linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.5))",backgroundSize:"cover",backgroundPosition:"center"};let e=n.value.backdropPath;return e=`https://image.tmdb.org/t/p/original${e}`,{backgroundImage:`linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9)), url(${e})`,backgroundSize:"cover",backgroundPosition:"center"}});return J(d,()=>{C()}),E(()=>{C()}),(e,o)=>{const $=c("el-skeleton"),b=c("el-button"),z=c("el-empty"),V=c("Plus"),m=c("el-icon"),B=c("Delete");return a(),l("div",de,[N.value?(a(),l("div",me,[i($,{rows:10,animated:""})])):U.value?(a(),l("div",ve,[i(z,{description:"获取电影详情失败","image-size":200},{default:u(()=>[i(b,{type:"primary",onClick:C},{default:u(()=>o[1]||(o[1]=[f("重试")])),_:1,__:[1]})]),_:1})])):n.value?(a(),l("div",_e,[s("div",{class:"backdrop",style:K(k.value)},null,4),s("div",pe,[s("div",fe,[i(b,{onClick:o[0]||(o[0]=Ae=>e.$router.go(-1)),type:"primary",plain:"",size:"small",icon:"ArrowLeft"},{default:u(()=>o[2]||(o[2]=[f("返回")])),_:1,__:[2]})]),s("div",ge,[s("div",ye,[n.value.posterPath?(a(),l("img",{key:0,src:t(n.value.posterPath),alt:"电影海报",class:"poster"},null,8,he)):(a(),l("div",ke,"暂无海报"))]),s("div",be,[s("h1",we,_(n.value.title),1),s("div",Ie,[n.value.releaseDate?(a(),l("span",Ce,_(S(n.value.releaseDate)),1)):w("",!0),n.value.imdbRating!=="N/A"?(a(),l("span",De,[o[3]||(o[3]=f(" IMDb评分：")),s("strong",null,_(n.value.imdbRating),1),f(" ("+_(n.value.imdbVotes)+" votes) ",1)])):w("",!0),n.value.budget!=="N/A"?(a(),l("span",Se," 预算："+_(r(n.value.budget)),1)):w("",!0),n.value.boxOffice!=="N/A"?(a(),l("span",$e," 票房："+_(r(n.value.boxOffice)),1)):w("",!0)]),s("div",Me,[I.value&&!h.value?(a(),F(b,{key:0,type:"primary",onClick:L},{default:u(()=>[i(m,null,{default:u(()=>[i(V)]),_:1}),o[4]||(o[4]=f(" 添加到影单 "))]),_:1,__:[4]})):I.value&&h.value?(a(),F(b,{key:1,type:"danger",onClick:D},{default:u(()=>[i(m,null,{default:u(()=>[i(B)]),_:1}),o[5]||(o[5]=f(" 从影单移除 "))]),_:1,__:[5]})):w("",!0)]),s("div",Ne,[o[6]||(o[6]=s("h3",null,"剧情简介",-1)),s("p",null,_(n.value.overview),1)])])]),i(ue,{"movie-id":d.value},null,8,["movie-id"])])])):w("",!0)])}}},ze=R(Ue,[["__scopeId","data-v-f7562dba"]]);export{ze as default};
